<!DOCTYPE html>
<html>
  <head>
    <title>PEAple - Arduino Coding Assistant</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        height: 100vh;
      }
      .header {
        background-color: #3498db;
        color: white;
        padding: 1rem;
        text-align: center;
      }
      .main {
        display: flex;
        flex: 1;
        overflow: hidden;
      }
      .sidebar {
        width: 300px;
        background-color: #f5f5f5;
        padding: 1rem;
        overflow-y: auto;
      }
      .chat-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 1rem;
      }
      .chat-messages {
        flex: 1;
        overflow-y: auto;
        border: 1px solid #ddd;
        padding: 1rem;
        border-radius: 4px;
        margin-bottom: 1rem;
      }
      .chat-input {
        display: flex;
      }
      .chat-input textarea {
        flex: 1;
        padding: 0.5rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        resize: none;
      }
      .chat-input button {
        padding: 0.5rem 1rem;
        background-color: #3498db;
        color: white;
        border: none;
        border-radius: 4px;
        margin-left: 0.5rem;
        cursor: pointer;
      }
      .project-form {
        margin-bottom: 1rem;
      }
      .message {
        margin-bottom: 1rem;
        padding: 0.5rem;
        border-radius: 4px;
      }
      .user-message {
        background-color: #e1f5fe;
        text-align: right;
      }
      .assistant-message {
        background-color: #f1f1f1;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>PEAple - Arduino Coding Assistant</h1>
    </div>
    <div class="main">
      <div class="sidebar">
        <h2>Project Settings</h2>
        <div class="project-form">
          <div>
            <label for="project-name">Project Name:</label>
            <input type="text" id="project-name" name="project-name" />
          </div>
          <div>
            <label for="board-select">Arduino Board:</label>
            <select id="board-select" name="board">
              <option value="">Select a board</option>
              <!-- Boards will be loaded here -->
            </select>
          </div>
          <div>
            <label for="components">Components:</label>
            <select id="components" name="components" multiple>
              <!-- Components will be loaded here -->
            </select>
          </div>
          <div>
            <label for="libraries">Libraries:</label>
            <select id="libraries" name="libraries" multiple>
              <!-- Libraries will be loaded here -->
            </select>
          </div>
          <button id="save-project">Save Project</button>
        </div>
      </div>
      <div class="chat-container">
        <div class="chat-messages" id="chat-messages">
          <div class="message assistant-message">
            Hello! I'm PEAple, your Arduino coding assistant. How can I help you
            today?
          </div>
        </div>
        <div class="chat-input">
          <textarea
            id="user-input"
            placeholder="Type your message here..."
          ></textarea>
          <button id="send-button">Send</button>
        </div>
      </div>
    </div>

    <script>
      // Global variables
      let currentConversationId = null;
      let currentProjectId = null;

      // Load boards, libraries, and components when the page loads
      document.addEventListener("DOMContentLoaded", function () {
        loadBoards();
        loadLibraries();
        loadComponents();
      });

      // Handle sending messages
      document
        .getElementById("send-button")
        .addEventListener("click", function () {
          sendMessage();
        });

      document
        .getElementById("user-input")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
          }
        });

      // Handle saving projects
      document
        .getElementById("save-project")
        .addEventListener("click", function () {
          saveProject();
        });

      // Function to load Arduino boards from the API
      function loadBoards() {
        fetch("/api/boards/")
          .then((response) => response.json())
          .then((data) => {
            const boardSelect = document.getElementById("board-select");
            boardSelect.innerHTML = '<option value="">Select a board</option>';

            data.forEach((board) => {
              const option = document.createElement("option");
              option.value = board.id;
              option.textContent = board.name;
              boardSelect.appendChild(option);
            });
          })
          .catch((error) => console.error("Error loading boards:", error));
      }

      // Function to load libraries from the API
      function loadLibraries() {
        fetch("/api/libraries/")
          .then((response) => response.json())
          .then((data) => {
            const librariesSelect = document.getElementById("libraries");
            librariesSelect.innerHTML = "";

            data.forEach((library) => {
              const option = document.createElement("option");
              option.value = library.id;
              option.textContent = library.name;
              librariesSelect.appendChild(option);
            });
          })
          .catch((error) => console.error("Error loading libraries:", error));
      }

      // Function to load components from the API
      function loadComponents() {
        fetch("/api/components/")
          .then((response) => response.json())
          .then((data) => {
            const componentsSelect = document.getElementById("components");
            componentsSelect.innerHTML = "";

            data.forEach((component) => {
              const option = document.createElement("option");
              option.value = component.id;
              option.textContent = component.name;
              componentsSelect.appendChild(option);
            });
          })
          .catch((error) => console.error("Error loading components:", error));
      }

      // Function to save a project
      function saveProject() {
        const projectName = document.getElementById("project-name").value;
        const boardId = document.getElementById("board-select").value;

        // Get selected libraries
        const librariesSelect = document.getElementById("libraries");
        const selectedLibraries = Array.from(
          librariesSelect.selectedOptions
        ).map((option) => option.value);

        // Get selected components
        const componentsSelect = document.getElementById("components");
        const selectedComponents = Array.from(
          componentsSelect.selectedOptions
        ).map((option) => option.value);

        if (!projectName) {
          alert("Please enter a project name");
          return;
        }

        const projectData = {
          name: projectName,
          board: boardId || null,
          libraries: selectedLibraries,
          components: selectedComponents,
          description: `Arduino project using ${
            boardId ? "board #" + boardId : "no specific board"
          }`,
        };

        // If we already have a project, update it; otherwise create a new one
        const method = currentProjectId ? "PUT" : "POST";
        const url = currentProjectId
          ? `/api/projects/${currentProjectId}/`
          : "/api/projects/";

        fetch(url, {
          method: method,
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie("csrftoken"),
          },
          body: JSON.stringify(projectData),
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error("Network response was not ok");
            }
            return response.json();
          })
          .then((data) => {
            currentProjectId = data.id;

            // If we already have a conversation, associate it with this project
            if (currentConversationId) {
              fetch(`/api/conversations/${currentConversationId}/`, {
                method: "PUT",
                headers: {
                  "Content-Type": "application/json",
                  "X-CSRFToken": getCookie("csrftoken"),
                },
                body: JSON.stringify({
                  project: currentProjectId,
                }),
              }).then((response) => {
                if (!response.ok) {
                  console.warn(
                    "Failed to update conversation with new project"
                  );
                }
              });
            }

            alert("Project saved successfully!");

            // Add a system message to the chat
            const boardName =
              document.getElementById("board-select").options[
                document.getElementById("board-select").selectedIndex
              ].text;
            const systemMessage = `Project "${projectName}" saved. ${
              boardName ? "Using " + boardName + "." : ""
            } ${
              selectedComponents.length
                ? selectedComponents.length + " components selected."
                : ""
            } ${
              selectedLibraries.length
                ? selectedLibraries.length + " libraries selected."
                : ""
            }`;

            addMessage(systemMessage, "assistant");
          })
          .catch((error) => {
            console.error("Error saving project:", error);
            alert("Failed to save project. Please try again.");
          });
      }

      // Function to send a message to the AI assistant
      function sendMessage() {
        const userInput = document.getElementById("user-input");
        const message = userInput.value.trim();

        if (!message) {
          return;
        }

        // Add user message to chat UI
        addMessage(message, "user");

        // Clear input
        userInput.value = "";

        // Prepare message data
        const messageData = {
          content: message,
          conversation_id: currentConversationId,
          project_id: currentProjectId,
        };

        // Send message to API
        fetch("/api/send-message/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie("csrftoken"),
          },
          body: JSON.stringify(messageData),
        })
          .then((response) => response.json())
          .then((data) => {
            // Update current conversation ID
            currentConversationId = data.conversation_id;

            // Add assistant message to chat
            addMessage(data.assistant_message.content, "assistant");
          })
          .catch((error) => {
            console.error("Error sending message:", error);
            addMessage(
              "Sorry, there was an error processing your message.",
              "assistant"
            );
          });
      }

      // Helper function to add messages to the chat UI
      function addMessage(content, sender) {
        const chatMessages = document.getElementById("chat-messages");
        const messageDiv = document.createElement("div");
        messageDiv.classList.add("message");
        messageDiv.classList.add(sender + "-message");
        messageDiv.textContent = content;
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      // Helper function to get CSRF token from cookies
      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
          const cookies = document.cookie.split(";");
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === name + "=") {
              cookieValue = decodeURIComponent(
                cookie.substring(name.length + 1)
              );
              break;
            }
          }
        }
        return cookieValue;
      }
    </script>
  </body>
</html>
